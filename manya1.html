<!doctype html>
<meta charset="utf-8" />
<title>Space Pays Back on Earth</title>
<script src="https://d3js.org/d3.v7.min.js"></script>
<style>
    body {
        font-family: system-ui, Arial;
        margin: 0;
        background: #0b1020;
        color: #eef2ff;
    }

    .wrap {
        max-width: 980px;
        margin: 0 auto;
        padding: 22px 16px 28px;
    }

    h1 {
        margin: 0 0 6px;
        font-size: 22px;
    }

    p {
        margin: 0 0 14px;
        color: #b6c0dd;
        max-width: 80ch;
        line-height: 1.35;
    }

    .row {
        display: flex;
        gap: 10px;
        flex-wrap: wrap;
        align-items: center;
        margin: 10px 0 12px;
    }

    button {
        border: 1px solid rgba(255, 255, 255, .15);
        background: rgba(255, 255, 255, .07);
        color: #eef2ff;
        padding: 8px 10px;
        border-radius: 999px;
        cursor: pointer;
        font-size: 12px;
    }

    button.active {
        border-color: rgba(124, 255, 178, .6);
        box-shadow: 0 0 0 2px rgba(124, 255, 178, .12) inset;
    }

    .card {
        background: rgba(255, 255, 255, .05);
        border: 1px solid rgba(255, 255, 255, .12);
        border-radius: 14px;
        padding: 12px;
    }

    .tip {
        position: fixed;
        pointer-events: none;
        opacity: 0;
        background: rgba(10, 16, 32, .95);
        border: 1px solid rgba(255, 255, 255, .14);
        border-radius: 12px;
        padding: 10px;
        max-width: 320px;
        box-shadow: 0 18px 40px rgba(0, 0, 0, .45);
        transform: translateY(8px);
        transition: opacity .08s, transform .08s;
        font-size: 12px;
    }

    .muted {
        color: #b6c0dd;
    }
</style>

<div class="wrap">
    <h1>Space Pays Back on Earth</h1>
    <p>
        This chart shows real-world technologies that came from (or were accelerated by) space R&amp;D.
        - made by using econ_impact.json
    </p>

    <div class="row">
        <span class="muted" style="font-size:12px;">Rank by:</span>
        <button id="btnEco" class="active">Economic Value (B$)</button>
        <button id="btnLives">Lives Saved</button>
    </div>

    <div class="card" id="viz"></div>
    <div class="muted" style="font-size:11px; margin-top:10px;">
        Tip: hover a bar. Click buttons to re-rank (animated).
    </div>
</div>

<div class="tip" id="tip"></div>

<script>
    (async function () {
        const raw = await d3.json("econ_impact.json");

        // Flatten leaves: categories -> tech items
        const items = [];
        for (const cat of raw.children) {
            for (const t of cat.children) {
                items.push({
                    category: cat.name,
                    name: t.name,
                    impactDetail: t.impactDetail ?? "",
                    economicValue: +t.economicValue || 0,   // B$
                    livesSaved: +t.livesSaved || 0,
                    scale: +t.value || 0
                });
            }
        }

        const tip = d3.select("#tip");
        const fmtB = d3.format(".1f");
        const fmtInt = d3.format(",");

        const el = document.getElementById("viz");
        const W = Math.min(940, el.clientWidth);
        const H = 520;
        const m = { top: 16, right: 20, bottom: 26, left: 210 };

        const svg = d3.select(el).append("svg")
            .attr("width", W)
            .attr("height", H);

        const g = svg.append("g").attr("transform", `translate(${m.left},${m.top})`);
        const iw = W - m.left - m.right;
        const ih = H - m.top - m.bottom;

        let metric = "economicValue"; // or "livesSaved"
        const topN = 12;

        const y = d3.scaleBand().range([0, ih]).padding(0.18);
        const x = d3.scaleLinear().range([0, iw]);

        const xAxisG = g.append("g").attr("transform", `translate(0,${ih})`);
        const yAxisG = g.append("g");

        const barsG = g.append("g");

        function color(category) {
            // simple deterministic color using category hash (keeps it expressive but not “fancy”)
            const h = d3.sum(category.split(""), c => c.charCodeAt(0));
            const t = (h % 360);
            return `hsl(${t}, 70%, 55%)`;
        }

        function getData() {
            return items
                .slice()
                .sort((a, b) => d3.descending(a[metric], b[metric]))
                .slice(0, topN);
        }

        function render(first = false) {
            const data = getData();

            y.domain(data.map(d => d.name));
            x.domain([0, d3.max(data, d => d[metric]) || 1]).nice();

            const t = svg.transition().duration(900).ease(d3.easeCubicOut);

            yAxisG.transition(t).call(d3.axisLeft(y).tickSize(0))
                .call(g => g.selectAll("text").attr("fill", "rgba(238,242,255,.92)").attr("font-size", 12))
                .call(g => g.select(".domain").remove());

            xAxisG.transition(t).call(d3.axisBottom(x).ticks(5))
                .call(g => g.selectAll("text").attr("fill", "rgba(182,192,221,.9)").attr("font-size", 11))
                .call(g => g.selectAll("path,line").attr("stroke", "rgba(255,255,255,.18)"));

            const bars = barsG.selectAll("rect").data(data, d => d.name);

            bars.join(
                enter => enter.append("rect")
                    .attr("x", 0)
                    .attr("y", d => y(d.name))
                    .attr("height", y.bandwidth())
                    .attr("rx", 10).attr("ry", 10)
                    .attr("fill", d => color(d.category))
                    .attr("width", first ? 0 : d => x(d[metric]))
                    .attr("opacity", 0.92)
                    .on("mousemove", (event, d) => {
                        tip.style("opacity", 1).style("transform", "translateY(0px)")
                            .style("left", (event.clientX + 12) + "px")
                            .style("top", (event.clientY + 12) + "px")
                            .html(`
              <div style="font-weight:800; margin-bottom:4px;">${d.name}</div>
              <div class="muted"><b>Category:</b> ${d.category}</div>
              <div class="muted"><b>Economic:</b> ${fmtB(d.economicValue)} B$</div>
              <div class="muted"><b>Lives saved:</b> ${fmtInt(d.livesSaved)}</div>
              <div class="muted"><b>Scale:</b> ${fmtInt(d.scale)}</div>
              <div style="margin-top:6px; color:#b6c0dd;">${d.impactDetail}</div>
            `);
                    })
                    .on("mouseleave", () => tip.style("opacity", 0).style("transform", "translateY(8px)"))
                    .transition(t)
                    .attr("width", d => x(d[metric])),
                update => update.transition(t)
                    .attr("y", d => y(d.name))
                    .attr("height", y.bandwidth())
                    .attr("width", d => x(d[metric])),
                exit => exit.transition(t).attr("width", 0).remove()
            );

            // value labels (simple, but expressive)
            const labels = barsG.selectAll("text.val").data(data, d => d.name);

            labels.join(
                enter => enter.append("text")
                    .attr("class", "val")
                    .attr("x", 6)
                    .attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                    .attr("fill", "rgba(7,10,18,.85)")
                    .attr("font-weight", 800)
                    .attr("font-size", 11)
                    .text(d => metric === "economicValue" ? `${fmtB(d.economicValue)}B` : fmtInt(d.livesSaved))
                    .attr("opacity", 0)
                    .transition(t)
                    .attr("x", d => Math.min(x(d[metric]) - 6, 10))
                    .attr("opacity", 1),
                update => update.transition(t)
                    .attr("y", d => y(d.name) + y.bandwidth() / 2 + 4)
                    .text(d => metric === "economicValue" ? `${fmtB(d.economicValue)}B` : fmtInt(d.livesSaved))
                    .attr("x", d => Math.min(x(d[metric]) - 6, 10)),
                exit => exit.remove()
            );
        }

        render(true);

        const btnEco = document.getElementById("btnEco");
        const btnLives = document.getElementById("btnLives");

        btnEco.onclick = () => {
            metric = "economicValue";
            btnEco.classList.add("active");
            btnLives.classList.remove("active");
            render(false);
        };

        btnLives.onclick = () => {
            metric = "livesSaved";
            btnLives.classList.add("active");
            btnEco.classList.remove("active");
            render(false);
        };
    })();
</script>